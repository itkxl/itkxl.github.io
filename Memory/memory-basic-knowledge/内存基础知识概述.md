
## 一、基本概念
大家在日常开发过程中，是否思考过一个问题，为什么手机可用内存远远大于手机的物理内存?   
带着这个问题来了解下述内容。

### 1.1 物理内存
在购买手机的时候，手机的内存大小是核心性能参数，它极大的影响了手机的速度与稳定性。这个参数就对应着物理内存，它是一个实实在在的物理设备（也可以参考电脑的内存条）。

内存是由多个连续的单元组成，每个单元被定义为一个字节，每个字节都配有唯一的物理地址，这些地址都是从0开始连续编码的。因此，如果手机上配有4G的内存，则其物理内存的空间范围可以从0延展到4GB。

在最早的计算机程序开发过程中，程序猿都是直接操作物理内存的，每个数据存在具体的什么位置，都需要程序猿自己负责。这就带来了几个问题：

- 复杂性：直接操作物理内存要求程序员精确地管理每一个内存地址，这不仅增加了编程的复杂性，也提高了出错的风险。程序员需要处理内存分配、地址计算等低级任务，分散了注意力，无法专注于程序的逻辑和功能开发。

- 安全性：所有程序共享同一个物理内存环境，不小心将数据写入到其他程序的内存中，可能造成崩溃。在这种情况下，也容易造成恶意程序可能可以访问其他程序的数据，造成数据泄漏。

- 拓展性：程序移植成本高，随着硬件的变化，程序可以需要重写或者是大幅度修改才能在新硬件上运行。
  
- 其他：在这种情况下，内存是无法被动态共享或者是按需分配的，资源利用率低，内存碎片问题处理复杂。


既然有这么多那么问题，该如何进行解决呢？你可以直接回答虚拟内存，但是这中间还有一个重要的概念，局部性原理。

### 1.2 局部性原理
局部性原理支出，在短时间内，程序执行倾向于只访问相对集中的内存区域。局部性通常有两种形式：
- 时间局部性：如果一个内存位置在某一时刻被访问，那么它在近期内很可能再次被访问。
- 空间局部性：如果一个内存位置被访问，那么附近的内存位置接下来也有很大的可能性被访问。因此，操作系统会预加载这些临济的数据到物理内存中，减少接下来数据加载的时间。

局部性原理揭示了一个重要的洞见：即对于内存需求巨大的程序，在任何给定的时刻，实际需要的物理内存是有限的。这为虚拟内存的设计提供你改了理论基础。

### 1.3 虚拟内存
在计算机科学中，有一句著名的格言：“任何问题都可以通过增加一个间接的中间层来解决。”虚拟内存正是这种思想的实践例证。它创建了一个抽象层，使每个程序都认为自己拥有一个连续且几乎无限大的内存空间（此处以64位系统为例），这个空间远大于实际物理内存的容量。这种抽象实现了以下几个目标：
- 内存隔离：虚拟内存为每个进程提供了独立的地址空间，增强了进程之间的安全和隔离。这意味着即使多个程序同时运行，它们也不会干扰到彼此的内存空间
- 内存管理的简化：程序员无需关心物理内存的实际限制或其它进程的内存使用情况，可以更专注于程序的开发。
- 资源的有效利用：通过按需分配物理内存，虚拟内存可以更有效地使用有限的物理资源。只有当数据真正需要时，它才被加载到物理内存中。
- 灵活性：虚拟内存使得操作系统能够控制哪些内存页需要保留在物理内存中，哪些可以暂时存放到磁盘上的交换空间（swap space）。这个交换空间允许系统在物理内存满载时，将不活跃的页面移出到硬盘，从而为活跃进程腾出空间。当这些被交换出的页面再次需要访问时，它们可以被重新加载回物理内存。

### 1.4 小结
虚拟内存让程序开发更加简单，增强了系统的安全性和灵活性，并且使得即使物理内存不够大，系统仍然可以支持运行大型应用程序。这也是前文提到的为什么手机的可用内存可以远远大于其物理内存的原因。


## 二、内存布局
在上面介绍了虚拟内存的由来后，接下来了解一下进程内部的虚拟内存布局，或者说虚拟内存是如何安排各种数据的。

